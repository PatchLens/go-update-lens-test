name: PatchLens on PRs

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Determine Go module directory
        id: determine-dir
        run: |
          BRANCH=${{ github.head_ref }}
          if [[ $BRANCH == dependabot/go_modules/* ]]; then
            # For dependabot PRs, extract directory from branch name
            REL=${BRANCH#dependabot/go_modules/}
            DIR=$(echo "$REL" | cut -d/ -f1-2)
          else
            # For manual PRs, find the directory with go.mod changes
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.head_ref }} | grep 'go.mod$' | head -1)
            if [[ -n "$CHANGED_FILES" ]]; then
              DIR=$(dirname "$CHANGED_FILES")
            fi
          fi
          echo "module_dir=$DIR" >> $GITHUB_OUTPUT

      - name: Run PatchLens Go Module Update Analysis
        uses: PatchLens/go-dep-impact-action@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          directory: ${{ steps.determine-dir.outputs.module_dir }}
